<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Traffic Flow Prediction System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-primary: #E5E7EB;
            --text-secondary: #D1D5DB;
            --accent-color: #818CF8;
            --success-color: #34D399;
            --info-color: #60A5FA;
        }
        html, body { 
            height: 100%; 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
        }
        body { 
            background: #111827;
            background-image: linear-gradient(135deg, #1E3A8A 0%, #3730A3 50%, #4F46E5 100%);
            color: var(--text-primary); 
            overflow: hidden;
        }
        #main-wrapper { height: 100vh; }
        #sidebar {
            width: 280px;
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0;
            transition: margin-left 0.3s;
        }
        #sidebar .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFFFFF;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #sidebar .nav-link {
            color: var(--text-secondary);
            padding: 0.85rem 1.5rem;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }
        #sidebar .nav-link.active, #sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #FFFFFF;
            border-left-color: var(--accent-color);
        }
        #content {
            width: calc(100% - 280px);
            padding: 2.5rem;
            overflow-y: auto;
        }
        #content::-webkit-scrollbar { width: 8px; }
        #content::-webkit-scrollbar-track { background: transparent; }
        #content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .card { 
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: var(--text-primary);
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: #FFFFFF;
        }
        .status-box {
            background-color: rgba(17, 24, 39, 0.7);
            border-radius: .5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #map, #route-map { height: 500px; width: 100%; border-radius: .5rem; border: 1px solid rgba(255, 255, 255, 0.1); }
        .spinner-border { display: none; }
        .form-label { font-weight: 500; color: var(--text-primary); }
        .form-control, .form-select {
            background-color: rgba(55, 65, 81, 0.5);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(55, 65, 81, 0.7);
            color: #FFFFFF;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25);
        }
        .form-control::placeholder { color: #9CA3AF; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        }
        .text-muted { color: #9CA3AF !important; }
        .modal-content {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        .modal-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-footer { border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-close { filter: invert(1); }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(31, 41, 55, 0.8);
            color: var(--text-primary);
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .stat-card {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .stat-card .stat-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .stat-card .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #FFFFFF;
        }
    </style>
</head>
<body>

<div class="d-flex" id="main-wrapper">
    <div id="sidebar" class="d-flex flex-column flex-shrink-0">
        <div class="sidebar-header text-center">
            <span>TFPS</span>
        </div>
        <ul class="nav nav-pills flex-column mt-2" id="sidebarTabs" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tab-dashboard" role="tab">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-data" role="tab">1. Data Processing</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-train" role="tab">2. Model Training</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-predict" role="tab">3. Prediction Map</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-routing" role="tab">4. Route Finding</a></li>
        </ul>
    </div>

    <div id="content">
        <div class="tab-content h-100">
            <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel">
                <h1 class="h2 mb-4">Dashboard</h1>
                <div id="dashboard-content">
                    <div class="card p-5 text-center">
                        <h1 class="display-5">Welcome to the Traffic Flow Prediction System</h1>
                        <p class="lead mt-3">Process data in Tab 2 to see statistics here.</p>
                        <hr class="my-4" style="border-color: rgba(255,255,255,0.2);">
                        <a class="btn btn-primary btn-lg mt-3" href="#" id="getStartedBtn" role="button">Get Started</a>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-data" role="tabpanel">
                <h1 class="h2 mb-4">Data Loading & Preprocessing</h1>
                 <div class="card">
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="dataFile" class="form-label">1. Upload Raw Data CSV</label>
                                <input type="file" class="form-control" id="dataFile" accept=".csv">
                            </div>
                            <div class="col-md-7">
                                <label for="headerRow" class="form-label">2. Specify Header Row (0-indexed)</label>
                                <input type="number" class="form-control" id="headerRow" value="0" min="0">
                            </div>
                            <div class="col-md-5 d-flex align-items-end">
                                <button class="btn btn-outline-light w-100" id="mapColumnsBtn" disabled>
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    3. Map Columns
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 d-grid">
                             <button class="btn btn-primary btn-lg" id="processBtn" disabled>
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                4. Load & Process Data
                            </button>
                        </div>
                        <div id="dataStatus" class="status-box mt-3">Status: Please select a CSV file to begin.</div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-train" role="tabpanel">
                <h1 class="h2 mb-4">Model Training</h1>
                <div class="card">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-8">
                                <label for="modelSelect" class="form-label">Select Model</label>
                                <select class="form-select" id="modelSelect">
                                    <option value="xgboost">XGBoost (Recommended for Accuracy)</option>
                                    <option value="lstm">LSTM (Long Short-Term Memory)</option>
                                    <option value="gru">GRU (Gated Recurrent Unit)</option>
                                    <option value="sae">Stacked Autoencoder</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="epochs" class="form-label">Epochs (for Deep Learning)</label>
                                <input type="number" class="form-control" id="epochs" value="50" min="1">
                            </div>
                        </div>
                         <div class="mt-4 d-grid">
                            <button class="btn btn-success btn-lg" id="trainBtn">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Train Model
                            </button>
                        </div>
                        <div id="trainStatus" class="status-box mt-3">Status: Ready to train.</div>
                        <div class="mt-3"><canvas id="lossChart" style="max-height: 350px;"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-predict" role="tabpanel">
                 <h1 class="h2 mb-4">Prediction & Visualization</h1>
                 <div class="card">
                    <div class="card-body p-4">
                        <h5>Batch Prediction from CSV</h5>
                        <p class="text-muted">Upload a CSV with the same structure as your training data.</p>
                        <div class="input-group">
                            <input type="file" class="form-control" id="predictFile" accept=".csv">
                            <button class="btn btn-info text-white" id="predictBtn">
                                 <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                 Upload & Predict
                            </button>
                        </div>
                         <div id="predictStatus" class="status-box mt-3">Status: Awaiting prediction file.</div>
                        <div class="row mt-4">
                            <div class="col-lg-7">
                                <h5>Results Map</h5>
                                <div id="map"></div>
                            </div>
                            <div class="col-lg-5">
                                <h5>Prediction Details</h5>
                                <div id="predictionDetails" class="table-responsive" style="max-height: 460px;">
                                    <div class="d-flex h-100 justify-content-center align-items-center">
                                        <p class="text-muted">Prediction details will appear here.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="tab-routing" role="tabpanel">
                <h1 class="h2 mb-4">Traffic-Aware Routing</h1>
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-body p-4">
                                <h5>Find Fastest Route</h5>
                                <div class="mb-3">
                                    <label for="startNode" class="form-label">Start Location</label>
                                    <select id="startNode" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="endNode" class="form-label">End Location</label>
                                    <select id="endNode" class="form-select"></select>
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-info text-white" id="findRouteBtn">
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        Find Route
                                    </button>
                                </div>
                                <div id="routeStatus" class="status-box mt-3">Status: Select start and end points.</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-body p-2">
                                <div id="route-map"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="mappingModal" tabindex="-1" aria-labelledby="mappingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mappingModalLabel">Map CSV Columns</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="mappingModalBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmMappingBtn">Confirm Mapping</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    let columnMapping = null;
    let lossChart = null;
    let hourlyTrafficChart = null;
    let routePolyline = null;

    // --- Map Initialization ---
    let predictionMap = L.map('map').setView([-37.814, 144.963], 12);
    let routeMap = L.map('route-map').setView([-37.814, 144.963], 12);
    
    const tileLayerURL = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    const tileLayerOptions = {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    };

    L.tileLayer(tileLayerURL, tileLayerOptions).addTo(predictionMap);
    L.tileLayer(tileLayerURL, tileLayerOptions).addTo(routeMap);
    
    let mapMarkers = [];

    // --- Tab & UI Logic ---
    $('a[data-bs-toggle="pill"]').on('shown.bs.tab', function (e) {
        const targetTab = e.target.href;
        if (targetTab.includes('predict')) predictionMap.invalidateSize();
        if (targetTab.includes('routing')) routeMap.invalidateSize();
        if (targetTab.includes('dashboard')) loadDashboardData();
    });
    
    $('#getStartedBtn').on('click', e => {
        e.preventDefault();
        $('#sidebarTabs a[href="#tab-data"]').tab('show');
    });

    // --- Dashboard ---
    function loadDashboardData() {
        $.get('/api/dashboard-stats', function(data) {
            const dashboardHtml = `
                <div class="row g-4">
                    <div class="col-md-4"><div class="stat-card"><div class="stat-title">Total Records</div><div class="stat-value">${data.totalRecords}</div></div></div>
                    <div class="col-md-4"><div class="stat-card"><div class="stat-title">Unique SCATS Sites</div><div class="stat-value">${data.uniqueSites}</div></div></div>
                    <div class="col-md-4"><div class="stat-card"><div class="stat-title">Date Range</div><div class="stat-value" style="font-size: 1.5rem;">${data.dateRange}</div></div></div>
                    <div class="col-12"><div class="card mt-4"><div class="card-header">Average Traffic Volume by Hour</div><div class="card-body"><canvas id="hourlyTrafficChart" style="max-height: 400px;"></canvas></div></div></div>
                </div>`;
            $('#dashboard-content').html(dashboardHtml);
            renderHourlyTrafficChart(data.trafficByHour);
        }).fail(xhr => {
            const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "Unknown error";
            $('#dashboard-content').html(`<div class="card p-5 text-center"><h1 class="display-5">Welcome!</h1><p class="lead mt-3 text-warning">${errorMsg}</p></div>`);
        });
    }

    function renderHourlyTrafficChart(trafficData) {
        const ctx = $('#hourlyTrafficChart');
        if (!ctx.length) return;
        if (hourlyTrafficChart) hourlyTrafficChart.destroy();
        hourlyTrafficChart = new Chart(ctx[0].getContext('2d'), {
            type: 'bar',
            data: { labels: Object.keys(trafficData), datasets: [{ label: 'Average Traffic Volume', data: Object.values(trafficData), backgroundColor: 'rgba(129, 140, 248, 0.5)', borderColor: 'rgba(129, 140, 248, 1)', borderWidth: 1 }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: 'white' }, grid: { display: false } } } }
        });
    }
    
    // --- Data Processing ---
    $('#dataFile').on('change', () => {
        if ($('#dataFile').val()) {
            $('#mapColumnsBtn').prop('disabled', false);
            $('#dataStatus').text('Status: File selected. Ready to map columns.');
        }
    });

    $('#mapColumnsBtn').on('click', function() {
        let fileInput = $('#dataFile')[0];
        if (!fileInput.files.length) return;
        let formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('header_row', $('#headerRow').val());
        showSpinner(this, true);
        $.ajax({
            url: '/get-headers', method: 'POST', data: formData, processData: false, contentType: false,
            success: r => {
                populateMappingModal(r.headers);
                new bootstrap.Modal($('#mappingModal')).show();
            },
            error: xhr => alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : "Unknown")),
            complete: () => showSpinner('#mapColumnsBtn', false)
        });
    });

    function populateMappingModal(headers) {
        const fields = {'scats_number':'SCATS Site ID','location':'Location Name (Opt)','latitude':'Latitude (Opt)','longitude':'Longitude (Opt)','date':'Date/DateTime','volume_columns':'Traffic Volume Columns'};
        let html = '';
        Object.entries(fields).forEach(([key, desc]) => {
            const isMulti = key === 'volume_columns';
            html += `<div class="mb-2"><label class="form-label fw-bold">${desc}</label><select class="form-select" id="map-${key}" ${isMulti ? 'multiple size="8"' : ''}>`;
            if (!isMulti) html += `<option value="">-- N/A --</option>`;
            headers.forEach(h => {
                const saneKey = key.replace("_", " ").toLowerCase();
                const saneHeader = h.toLowerCase().trim();
                const isSelected = isMulti ? (saneHeader.startsWith('v') || saneHeader.includes('vol')) : (saneKey.split(' ')[0] === saneHeader.split(' ')[0]);
                html += `<option value="${h}" ${isSelected ? 'selected' : ''}>${h}</option>`;
            });
            html += '</select></div>';
        });
        $('#mappingModalBody').html(html);
    }

    $('#confirmMappingBtn').on('click', function() {
        columnMapping = {};
        $('#mappingModalBody select').each(function() {
            let id = $(this).attr('id').replace('map-', '');
            if ($(this).val()) columnMapping[id] = $(this).val();
        });
        if (!columnMapping.volume_columns || columnMapping.volume_columns.length === 0) return alert('Must select at least one Volume column.');
        $('#processBtn').prop('disabled', false);
        $('#dataStatus').text('Status: Columns mapped. Ready to process.');
        bootstrap.Modal.getInstance($('#mappingModal')).hide();
    });

    $('#processBtn').on('click', function() {
        if (!$('#dataFile')[0].files.length || !columnMapping) return;
        let formData = new FormData();
        formData.append('file', $('#dataFile')[0].files[0]);
        formData.append('header_row', $('#headerRow').val());
        formData.append('column_mapping', JSON.stringify(columnMapping));
        showSpinner(this, true);
        $('#dataStatus').text('Status: Preprocessing... This may take a moment.');
        $.ajax({
            url: '/preprocess', method: 'POST', data: formData, processData: false, contentType: false,
            success: r => {
                $('#dataStatus').html(`<span class="text-success">Success! ${r.rows_processed} rows processed.</span>`);
                loadDashboardData();
                populateScatsDropdowns();
            },
            error: xhr => $('#dataStatus').html(`<span class="text-danger">Error: ${xhr.responseJSON.error}</span>`),
            complete: () => showSpinner('#processBtn', false)
        });
    });

    // --- Model Training ---
    $('#trainBtn').on('click', function() {
        showSpinner(this, true);
        $('#trainStatus').text(`Status: Training ${$('#modelSelect').val().toUpperCase()} model...`);
        $.ajax({
            url: '/train', method: 'POST', contentType: 'application/json',
            data: JSON.stringify({ model: $('#modelSelect').val(), epochs: $('#epochs').val() }),
            success: r => {
                $('#trainStatus').html(`<span class="text-success">${r.message}</span>`);
                renderLossChart(r.history);
            },
            error: xhr => $('#trainStatus').html(`<span class="text-danger">Error: ${xhr.responseJSON.error}</span>`),
            complete: () => showSpinner('#trainBtn', false)
        });
    });

    function renderLossChart(history) {
        const ctx = $('#lossChart');
        if (!ctx.length || !history) return;
        if(lossChart) lossChart.destroy();
        lossChart = new Chart(ctx[0].getContext('2d'), {
            type: 'line',
            data: {
                labels: Array.from({length: history.loss.length}, (_, i) => i + 1),
                datasets: [
                    { label: 'Training Loss', data: history.loss, borderColor: 'rgba(129, 140, 248, 1)', backgroundColor: 'rgba(129, 140, 248, 0.2)', fill: true },
                    { label: 'Validation Loss', data: history.val_loss || (history.eval_set ? history.eval_set[1] : []), borderColor: 'rgba(251, 146, 60, 1)', backgroundColor: 'rgba(251, 146, 60, 0.2)', fill: true }
                ]
            },
            options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { title: { display: true, text: 'Epoch', color: 'white' }, ticks: { color: 'white' }, grid: { display: false } } } }
        });
    }

    // --- Prediction ---
    $('#predictBtn').on('click', function() {
        let fileInput = $('#predictFile')[0];
        if (!fileInput.files.length) return;
        let formData = new FormData();
        formData.append('file', fileInput.files[0]);
        showSpinner(this, true);
        $('#predictStatus').text('Status: Predicting...');
        $.ajax({
            url: '/predict-csv', method: 'POST', data: formData, processData: false, contentType: false,
            success: r => {
                $('#predictStatus').html(`<span class="text-success">Prediction complete. ${r.length} results.</span>`);
                renderPredictionResults(r);
            },
            error: xhr => $('#predictStatus').html(`<span class="text-danger">Error: ${xhr.responseJSON.error}</span>`),
            complete: () => showSpinner('#predictBtn', false)
        });
    });

    function renderPredictionResults(data) {
        mapMarkers.forEach(m => predictionMap.removeLayer(m));
        mapMarkers = [];
        let tableHtml = '<table class="table table-sm table-dark table-striped table-hover"><thead><tr><th>ID</th><th>DateTime</th><th>Prediction</th></tr></thead><tbody>';
        let validLocations = [];
        data.forEach(row => {
            tableHtml += `<tr><td>${row.scats_id}</td><td>${row.datetime}</td><td>${row.prediction}</td></tr>`;
            if (row.lat && row.lng && row.lat != 0 && row.lng != 0) {
                let marker = L.marker([row.lat, row.lng]).addTo(predictionMap).bindPopup(`<strong>ID: ${row.scats_id}</strong><br>Prediction: ${row.prediction}`);
                mapMarkers.push(marker);
                validLocations.push([row.lat, row.lng]);
            }
        });
        $('#predictionDetails').html(tableHtml + '</tbody></table>');
        if (validLocations.length > 0) predictionMap.fitBounds(validLocations, { padding: [50, 50] });
    }

    // --- Routing ---
    function populateScatsDropdowns() {
        $.get('/api/scats-locations', function(locations) {
            const startNode = $('#startNode');
            const endNode = $('#endNode');
            startNode.empty().append('<option selected disabled>Choose a starting point...</option>');
            endNode.empty().append('<option selected disabled>Choose a destination...</option>');
            locations.forEach(loc => {
                const option = `<option value="${loc.id}">${loc.id} - ${loc.name}</option>`;
                startNode.append(option);
                endNode.append(option);
            });
        });
    }

    $('#findRouteBtn').on('click', function() {
        const startNode = $('#startNode').val();
        const endNode = $('#endNode').val();
        if (!startNode || !endNode) return alert('Please select both a start and end location.');
        
        showSpinner(this, true);
        $('#routeStatus').text('Status: Finding fastest route...');

        $.ajax({
            url: '/api/find-route',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ start_node: startNode, end_node: endNode }),
            success: r => {
                $('#routeStatus').html(`<span class="text-success">Route found! Path displayed on map.</span>`);
                if (routePolyline) routeMap.removeLayer(routePolyline);
                routePolyline = L.polyline(r.path, { color: '#60A5FA', weight: 5 }).addTo(routeMap);
                routeMap.fitBounds(routePolyline.getBounds(), { padding: [20, 20] });
            },
            error: xhr => $('#routeStatus').html(`<span class="text-danger">Error: ${xhr.responseJSON.error}</span>`),
            complete: () => showSpinner('#findRouteBtn', false)
        });
    });
    
    function showSpinner(button, show) {
        $(button).find('.spinner-border').toggle(show);
        $(button).prop('disabled', show);
    }
});
</script>
</body>
</html>